<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Graphiti</title>
  <meta name="description" content="A stylish alternative to GraphQL">

  <link rel="stylesheet" href="https://graphiti-api.github.io/graphiti/assets/main.css?ref=wh4t3v45">
  <link rel="alternate" type="application/rss+xml" title="Graphiti" href="/feed.xml">

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-127904727-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-127904727-1');
  </script>

  <!-- javascript -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

  
</head>


  <body>
    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <header class="navbar navbar-inverse normal" role="banner">
  <div class="container">
    <div class="navbar-header">
      <button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".bs-navbar-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a href="https://graphiti-api.github.io/graphiti" class="navbar-brand">Graphiti</a>
    </div>
    <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
      <ul class="nav navbar-nav">
        <li>
          <a class="nav-link" href="https://graphiti-api.github.io/graphiti/quickstart">Quickstart</a>
        </li>
        <li>
          <a class="nav-link" href="https://graphiti-api.github.io/graphiti/guides">Guides</a>
        </li>
        <li>
          <a class="nav-link" href="https://graphiti-api.github.io/graphiti/tutorial">Tutorial</a>
        </li>
        <li>
          <a class="nav-link" href="https://graphiti-api.github.io/graphiti/js">Spraypaint</a>
        </li>
      </ul>
      <ul class="nav navbar-nav navbar-right visible-md visible-lg">
        <li>
          <a href="https://github.com/graphiti-api/graphiti" class="button">Fork on Github</a>
        </li>
      </ul>
    </nav>
  </div>
</header>

        <div class="container">
          <div class="toc col-md-3">
  <h1 id="testing">Testing</h1>

  <ul>
    <li>1 <a href="#overview">Overview</a>
      <ul>
        <li><a href="#api-vs-resource">API vs Resource</a></li>
        <li><a href="#factories">Factories</a></li>
        <li><a href="#rspec">RSpec</a></li>
      </ul>
    </li>
    <li>2 <a href="#test-helpers">Test Helpers</a>
      <ul>
        <li><a href="#jsonapidata"><code class="highlighter-rouge">#jsonapi_data</code></a>
          <ul>
            <li><a href="#accessing-sideloads">Accessing Sideloads</a></li>
            <li><a href="#accessing-links">Accessing Links</a></li>
          </ul>
        </li>
        <li><a href="#json"><code class="highlighter-rouge">json</code></a></li>
        <li><a href="#datetime"><code class="highlighter-rouge">datetime</code></a></li>
        <li><a href="#jsonapierrors"><code class="highlighter-rouge">jsonapi_errors</code></a></li>
        <li><a href="#resource-test-helpers">Resource Test Helpers</a></li>
        <li><a href="#api-test-helpers">API Test Helpers</a></li>
      </ul>
    </li>
    <li>3 <a href="#resource-tests">Resource Tests</a>
      <ul>
        <li><a href="#reads">Reads</a>
          <ul>
            <li><a href="#serialization">Serialization</a></li>
            <li><a href="#filtering">Filtering</a></li>
            <li><a href="#sorting">Sorting</a></li>
            <li><a href="#sideloading">Sideloading</a></li>
          </ul>
        </li>
        <li><a href="#writes">Writes</a>
          <ul>
            <li><a href="#create">Create</a>
              <ul>
                <li><a href="#required-belongs-to">Required belongs_to</a></li>
              </ul>
            </li>
            <li><a href="#update">Update</a></li>
            <li><a href="#destroy">Destroy</a></li>
            <li><a href="#side-effects">Side Effects</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li>4 <a href="#api-tests">API Tests</a>
      <ul>
        <li><a href="#reads-1">Reads</a>
          <ul>
            <li><a href="#index">Index</a></li>
            <li><a href="#show">Show</a></li>
          </ul>
        </li>
        <li><a href="#writes-1">Writes</a>
          <ul>
            <li><a href="#create-1">Create</a></li>
            <li><a href="#update-1">Update</a></li>
            <li><a href="#destroy-1">Destroy</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li>5 <a href="#context">Context</a></li>
    <li>6 <a href="#schema-validation">Schema Validation</a></li>
    <li>7 <a href="#testing-spectrum">Testing Spectrum</a></li>
    <li>8 <a href="double-testing-units">Double-Testing Units</a></li>
    <li>9 <a href="#generators">Generators</a></li>
  </ul>

</div>

<div class="col-md-8">
  <h2 id="overview">1 Overview</h2>

  <p>Test first.</p>

  <p>Wait, hear me out!</p>

  <p><a href="http://david.heinemeierhansson.com/2014/tdd-is-dead-long-live-testing.html">Even if you’re not a fan of TDD</a>, Graphiti <em>integration</em> tests are simply the easiest, most pleasant way to develop.
In fact, most Graphiti development can happen without even opening a browser.
And as a side effect, you get a reliable test suite.</p>

  <p>Let’s say we want to filter Employees by <code class="highlighter-rouge">title</code>, which comes from
the <code class="highlighter-rouge">positions</code> table. Start with a spec:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">EmployeeResource</span><span class="p">,</span> <span class="ss">type: :resource</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s1">'filtering'</span> <span class="k">do</span>
    <span class="n">context</span> <span class="s1">'by title'</span> <span class="k">do</span>
      <span class="c1"># GIVEN some seed data</span>
      <span class="n">let!</span><span class="p">(</span><span class="ss">:employee1</span><span class="p">)</span> <span class="p">{</span> <span class="n">create</span><span class="p">(</span><span class="ss">:employee</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">let!</span><span class="p">(</span><span class="ss">:employee2</span><span class="p">)</span> <span class="p">{</span> <span class="n">create</span><span class="p">(</span><span class="ss">:employee</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">let!</span><span class="p">(</span><span class="ss">:position1</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">create</span> <span class="ss">:position</span><span class="p">,</span>
          <span class="ss">title: </span><span class="s1">'foo'</span><span class="p">,</span>
          <span class="ss">employee: </span><span class="n">employee1</span>
      <span class="k">end</span>
      <span class="n">let!</span><span class="p">(</span><span class="ss">:position2</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">create</span> <span class="ss">:position</span><span class="p">,</span>
          <span class="ss">title: </span><span class="s1">'bar'</span><span class="p">,</span>
          <span class="ss">employee: </span><span class="n">employee2</span>
      <span class="k">end</span>

      <span class="c1"># WHEN a parameter is set</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">params</span><span class="p">[</span><span class="ss">:filter</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">title: </span><span class="s1">'bar'</span> <span class="p">}</span>
      <span class="k">end</span>

      <span class="c1"># THEN the query results will be correct</span>
      <span class="n">it</span> <span class="s1">'works'</span> <span class="k">do</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">records</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:id</span><span class="p">)).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">([</span><span class="n">employee2</span><span class="p">.</span><span class="nf">id</span><span class="p">])</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

  <p>By developing test-first:</p>

  <ul>
    <li>We don’t need to struggle with seeding local development data or
finding the right records for specific scenarios - we can
seed randomized data on-the-fly with <a href="https://github.com/thoughtbot/factory_bot">factories</a>.</li>
    <li>There’s no need to spin up a server and refresh browser pages,
mentally parsing the response payload.</li>
    <li>We get a high-confidence test “for free”.</li>
    <li>Because our integration test is separate from implementation, we don’t
need to worry about <a href="http://david.heinemeierhansson.com/2014/test-induced-design-damage.html">test-induced design damage</a>.</li>
  </ul>

  <h3 id="api-vs-resource">1.1 API vs Resource</h3>

  <p>There are two types of Graphiti tests: <strong>API tests</strong> and <strong>Resource
tests</strong>.</p>

  <p>This is because the same Resource logic can be re-used at multiple
endpoints. PostResource can be referenced at <code class="highlighter-rouge">/posts</code>, <code class="highlighter-rouge">/top_posts</code>,
and <code class="highlighter-rouge">/admin/posts</code>, but we shouldn’t have to test the same filtering and
sorting logic over and over. Querying, persistence, and serialization are
all Resource responsibilities, tested in Resource tests.</p>

  <p>We still want API tests, though, to test everything outside of the
Resource: routing, middleware, cache rules, response codes, etc…</p>

  <p>Typically, you’ll write the API test <strong>once</strong> and not have to touch it
again.</p>

  <h3 id="factories">1.2 Factories</h3>

  <blockquote>
    <p>Note: Factories are not <strong>required</strong>, but they are considered a best
practice used by the Graphiti test generator. Read thoughtbot’s
<a href="https://robots.thoughtbot.com/why-factories">Why Factories?</a> for more
information.</p>
  </blockquote>

  <p>We need to seed data into our test database. To do this, we use <a href="https://github.com/thoughtbot/factory_bot">Factory
Bot</a> and <a href="https://github.com/stympy/faker">Faker</a>.</p>

  <p>When you generate a model, a stub factory will be created. It is highly
recommended you edit that factory with randomized data:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># BEFORE</span>
<span class="no">FactoryBot</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:employee</span> <span class="k">do</span>
    <span class="n">first_name</span> <span class="p">{</span> <span class="s1">'MyString'</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># AFTER</span>
<span class="no">FactoryBot</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:employee</span> <span class="k">do</span>
    <span class="n">first_name</span> <span class="p">{</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Name</span><span class="p">.</span><span class="nf">first_name</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

  <p>This will help catch edge cases and provide more clarity than seeing the
same <code class="highlighter-rouge">"MyString"</code> everywhere.</p>

  <p>It’s a best practice that if a factory defines an attribute, there
should be a corresponding validation around that attribute. If an
attribute is optional, it should not be defaulted in a factory.</p>

  <p>Finally, <a href="https://blog.bigbinary.com/2016/02/15/rails-5-makes-belong-to-association-required-by-default.html">Rails 5 made belongs_to required by default</a>. This means that if Employee <code class="highlighter-rouge">belongs_to :department</code>, then <code class="highlighter-rouge">create(:employee)</code> will fail. To ensure a relationship is always seeded:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">FactoryBot</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
  <span class="n">factory</span> <span class="ss">:employee</span> <span class="k">do</span>
    <span class="n">department</span>
    <span class="c1"># OR association :department, factory: :department</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

  <h3 id="rspec">1.3 RSpec</h3>

  <p>RSpec is not <strong>required</strong>, but considered a first-class citizen used by the
Graphiti test generator.</p>

  <h2 id="test-helpers">2 Test Helpers</h2>

  <p>Tests are run using <a href="http://jsonapi.org/format/#fetching-includes">JSONAPI standards</a>. But the
JSONAPI payload can be a pain to deal with. So, we’ve supplied helpers.</p>

  <p>These helpers are defined in the <a href="https://github.com/graphiti-api/graphiti_errors">Graphiti Spec Helpers</a> gem.</p>

  <h3 id="jsonapidata">2.1 <code class="highlighter-rouge">#jsonapi_data</code></h3>

  <blockquote>
    <p>Note: for brevity, this method is aliased to <code class="highlighter-rouge">d</code></p>
  </blockquote>

  <p>The <code class="highlighter-rouge">jsonapi_data</code> method will parse response data and return a
normalized object (<code class="highlighter-rouge">GraphitiSpecHelpers::Node</code>). Assert against this the same way you assert against
JSON:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">data</span> <span class="o">=</span> <span class="n">jsonapi_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">expect</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">id</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="n">employee</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>
<span class="n">expect</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">jsonapi_type</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">'employees'</span><span class="p">)</span>
<span class="n">expect</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">first_name</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">'Jane'</span><span class="p">)</span></code></pre></figure>

  <ul>
    <li><code class="highlighter-rouge">id</code> will automatically case to an integer. If you would like to avoid
this, use <code class="highlighter-rouge">rawid</code> instead.</li>
    <li><code class="highlighter-rouge">jsonapi_type</code> is a convenience method for <code class="highlighter-rouge">data/type</code>, to avoid
conflicting with an attribute of the same name.</li>
    <li>If the <code class="highlighter-rouge">first_name</code> key was not present in the response, an error will
be raised.</li>
  </ul>

  <h4 id="accessing-sideloads">2.2 Accessing Sideloads</h4>

  <p>To grab a relationship:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">sideload</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">sideload</span><span class="p">(</span><span class="ss">:comments</span><span class="p">)</span>
<span class="n">expect</span><span class="p">(</span><span class="n">sideload</span><span class="p">.</span><span class="nf">id</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
<span class="n">expect</span><span class="p">(</span><span class="n">sideload</span><span class="p">.</span><span class="nf">jsonapi_type</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">'comments'</span><span class="p">)</span>
<span class="n">expect</span><span class="p">(</span><span class="n">sideload</span><span class="p">.</span><span class="nf">body</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">'body'</span><span class="p">)</span></code></pre></figure>

  <p>The <code class="highlighter-rouge">sideload</code> method accepts the <em>name of the relationship</em>. It returns
a normal <code class="highlighter-rouge">jsonapi_data</code> <code class="highlighter-rouge">GraphitiSpecHelpers::Node</code> containing the <code class="highlighter-rouge">include</code>-ed data.</p>

  <h4 id="accessing-links">2.3 Accessing Links</h4>

  <p>To grab a Link:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">link</span><span class="p">(</span><span class="ss">:comments</span><span class="p">,</span> <span class="ss">:related</span><span class="p">)</span></code></pre></figure>

  <p>This accepts the relationship name and the link type. It will return the
link URL.</p>

  <h3 id="json">2.2 <code class="highlighter-rouge">#json</code></h3>

  <p>To see the raw JSON response, use <code class="highlighter-rouge">json</code>.</p>

  <h3 id="datetime">2.3 <code class="highlighter-rouge">#datetime</code></h3>

  <p>In Graphiti, datetimes are rendered in <a href="https://www.iso.org/iso-8601-date-and-time-format.html">ISO 8601 format</a>. This means that straight date comparisons will fail:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># WRONG</span>
<span class="n">expect</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">created_at</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="n">post</span><span class="p">.</span><span class="nf">created_at</span><span class="p">)</span></code></pre></figure>

  <p>Instead, use the <code class="highlighter-rouge">datetime</code> helper to convert to ISO 8601 and compare
apples to apples:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># RIGHT</span>
<span class="n">expect</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">created_at</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="n">post</span><span class="p">.</span><span class="nf">created_at</span><span class="p">))</span></code></pre></figure>

  <h3 id="jsonapierrors">2.4 <code class="highlighter-rouge">#jsonapi_errors</code></h3>

  <blockquote>
    <p>This method is aliased to <code class="highlighter-rouge">errors</code> for brevity</p>
  </blockquote>

  <p>To parse an <a href="http://jsonapi.org/format/#errors">Errors Payload</a>:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">errors</span> <span class="o">=</span> <span class="n">jsonapi_errors</span>

<span class="c1"># Direct access</span>
<span class="n">expect</span><span class="p">(</span><span class="n">errors</span><span class="p">.</span><span class="nf">length</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">expect</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">attribute</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="ss">:name</span><span class="p">)</span>
<span class="n">expect</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">status</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">'422'</span><span class="p">)</span>
<span class="n">expect</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">title</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">'Validation Error'</span><span class="p">)</span>
<span class="n">expect</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">detail</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s2">"Name can't be blank"</span><span class="p">)</span>
<span class="n">expect</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">code</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="ss">:blank</span><span class="p">)</span>
<span class="n">expect</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">message</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s2">"can't be blank"</span><span class="p">)</span>

<span class="c1"># By attribute</span>
<span class="n">expect</span><span class="p">(</span><span class="n">errors</span><span class="p">.</span><span class="nf">name</span><span class="p">.</span><span class="nf">message</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s2">"can't be blank"</span><span class="p">)</span>
<span class="n">expect</span><span class="p">(</span><span class="n">errors</span><span class="p">.</span><span class="nf">name</span><span class="p">.</span><span class="nf">code</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="ss">:blank</span><span class="p">)</span>
<span class="c1"># ... etc ...</span>

<span class="c1"># As a hash</span>
<span class="n">expect</span><span class="p">(</span><span class="n">errors</span><span class="p">.</span><span class="nf">to_h</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">({</span>
  <span class="ss">name: </span><span class="s2">"can't be blank"</span>
<span class="p">})</span></code></pre></figure>

  <h3 id="resource-test-helpers">2.5 Resource Test Helpers</h3>

  <p>Resource tests have two helpers, both different ways to execute a query.</p>

  <p><code class="highlighter-rouge">render</code> will fire the query and return a JSON response that can be
accessed as normal:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">it</span> <span class="s1">'works'</span> <span class="k">do</span>
  <span class="n">render</span>
  <span class="n">expect</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">first_name</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">'Jane'</span><span class="p">)</span>
  <span class="n">json</span> <span class="c1"># =&gt; { data: { type: 'employees', ... } }</span>
<span class="k">end</span></code></pre></figure>

  <p><code class="highlighter-rouge">records</code> will return model instances:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">it</span> <span class="s1">'works'</span> <span class="k">do</span>
  <span class="n">render</span>
  <span class="n">expect</span><span class="p">(</span><span class="n">records</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:id</span><span class="p">)).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
<span class="k">end</span></code></pre></figure>

  <h3 id="api-test-helpers">2.6 API Test Helpers</h3>

  <p>When executing an API test request, always use the <code class="highlighter-rouge">jsonapi_</code> doppelgänger:</p>

  <ul>
    <li><code class="highlighter-rouge">jsonapi_get(url, params:)</code> instead of <code class="highlighter-rouge">get</code></li>
    <li><code class="highlighter-rouge">jsonapi_post(url, payload)</code> instead of <code class="highlighter-rouge">post</code></li>
    <li><code class="highlighter-rouge">jsonapi_put(url, payload)</code> instead of <code class="highlighter-rouge">put</code></li>
    <li><code class="highlighter-rouge">jsonapi_patch(url, payload)</code> instead of <code class="highlighter-rouge">patch</code></li>
    <li><code class="highlighter-rouge">jsonapi_delete(url)</code> instead of <code class="highlighter-rouge">delete</code></li>
  </ul>

  <p>This will set the <code class="highlighter-rouge">CONTENT_TYPE</code> header to <code class="highlighter-rouge">application/vnd.api+json</code>
and call <code class="highlighter-rouge">to_json</code> on the payload (when applicable).</p>

  <p>It also allows overriding <code class="highlighter-rouge">jsonapi_headers</code>. Use this to manipulate
headers for a given request:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">jsonapi_headers</span>
  <span class="p">{}.</span><span class="nf">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">headers</span><span class="o">|</span>
    <span class="n">headers</span><span class="p">[</span><span class="s1">'CUSTOM'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'foo'</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

  <h2 id="resource-tests">3 Resource Tests</h2>

  <p>There are two test files for each Resource:</p>

  <ul>
    <li><code class="highlighter-rouge">spec/resources/post/reads_spec.rb</code></li>
    <li><code class="highlighter-rouge">spec/resources/post/writes_spec.rb</code></li>
  </ul>

  <h3 id="reads">3.1 Reads</h3>

  <p>The basic setup for read operations:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># spec/resources/employee/reads_spec.rb</span>
<span class="nb">require</span> <span class="s1">'rails_helper'</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">EmployeeResource</span><span class="p">,</span> <span class="ss">type: :resource</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s1">'serialization'</span> <span class="k">do</span>
    <span class="c1"># ... code ...</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s1">'filtering'</span> <span class="k">do</span>
    <span class="c1"># ... code ...</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s1">'sorting'</span> <span class="k">do</span>
    <span class="c1"># ... code ...</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s1">'sideloading'</span> <span class="k">do</span>
    <span class="c1"># ... code ...</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

  <h4 id="serialization">3.1.1 Serialization</h4>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">describe</span> <span class="s1">'serialization'</span> <span class="k">do</span>
  <span class="n">let!</span><span class="p">(</span><span class="ss">:employee</span><span class="p">)</span> <span class="p">{</span> <span class="n">create</span><span class="p">(</span><span class="ss">:employee</span><span class="p">,</span> <span class="ss">first_name: </span><span class="s1">'Jane'</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">it</span> <span class="s1">'works'</span> <span class="k">do</span>
    <span class="n">render</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">jsonapi_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">id</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="n">employee</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">jsonapi_type</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">'employees'</span><span class="p">)</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">first_name</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">'Jane'</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

  <p>We want to test that our attributes render correctly. We’ll do this by
seeding a record, firing a basic query, and comparing the JSON result to
the seeded data.</p>

  <p>Best practices:</p>

  <ul>
    <li>Assert on all attributes, even if there is no logic. This way adding
logic will cause a test failure.</li>
    <li>When seeding data, manually assign values. This way you can be assured
you aren’t accidentally testing <code class="highlighter-rouge">nil == nil</code></li>
  </ul>

  <p>If you decide you have a high level of confidence in your factories, you
can instead save some keystrokes and assert on randomized data:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">expect</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">first_name</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="n">employee</span><span class="p">.</span><span class="nf">first_name</span><span class="p">)</span></code></pre></figure>

  <blockquote>
    <p>Note: Our schema validation test will ensure no attributes get
removed or change types.</p>
  </blockquote>

  <h4 id="filtering">3.1.2 Filtering</h4>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">describe</span> <span class="s1">'filtering'</span> <span class="k">do</span>
  <span class="n">let!</span><span class="p">(</span><span class="ss">:employee1</span><span class="p">)</span> <span class="p">{</span> <span class="n">create</span><span class="p">(</span><span class="ss">:employee</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">let!</span><span class="p">(</span><span class="ss">:employee2</span><span class="p">)</span> <span class="p">{</span> <span class="n">create</span><span class="p">(</span><span class="ss">:employee</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">context</span> <span class="s1">'by id'</span> <span class="k">do</span>
    <span class="n">before</span> <span class="k">do</span>
      <span class="n">params</span><span class="p">[</span><span class="ss">:filter</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">id: </span><span class="p">{</span> <span class="ss">eq: </span><span class="n">employee2</span><span class="p">.</span><span class="nf">id</span> <span class="p">}</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'works'</span> <span class="k">do</span>
      <span class="n">render</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:id</span><span class="p">)).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">([</span><span class="n">employee2</span><span class="p">.</span><span class="nf">id</span><span class="p">])</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

  <p>Here we seed data, set the filter parameter, and assert only records
matching the given criteria are present in the response.</p>

  <p>In general, you only need to test filtering when there is custom logic.
Our schema validation test will ensure no filters are removed, guarded,
changed operators, etc.</p>

  <h4 id="sorting">3.1.3 Sorting</h4>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">describe</span> <span class="s1">'sorting'</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s1">'by id'</span> <span class="k">do</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:employee1</span><span class="p">)</span> <span class="p">{</span> <span class="n">create</span><span class="p">(</span><span class="ss">:employee</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:employee2</span><span class="p">)</span> <span class="p">{</span> <span class="n">create</span><span class="p">(</span><span class="ss">:employee</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">context</span> <span class="s1">'when ascending'</span> <span class="k">do</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">params</span><span class="p">[</span><span class="ss">:sort</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'id'</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s1">'works'</span> <span class="k">do</span>
        <span class="n">render</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:id</span><span class="p">)).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">([</span>
          <span class="n">employee1</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span>
          <span class="n">employee2</span><span class="p">.</span><span class="nf">id</span>
        <span class="p">])</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">context</span> <span class="s1">'when descending'</span> <span class="k">do</span>
      <span class="n">before</span> <span class="k">do</span>
        <span class="n">params</span><span class="p">[</span><span class="ss">:sort</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'-id'</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s1">'works'</span> <span class="k">do</span>
        <span class="n">render</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:id</span><span class="p">)).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">([</span>
          <span class="n">employee2</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span>
          <span class="n">employee1</span><span class="p">.</span><span class="nf">id</span>
        <span class="p">])</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

  <p>Here we seed data, set the sort parameter, and assert the correct order
of the rendered response.</p>

  <p>In general, you only need to test sorting when there is custom logic.
Our schema validation test will ensure no sorts are removed, guarded or
limited in direction.</p>

  <h4 id="sideloading">3.1.4 Sideloading</h4>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">describe</span> <span class="s1">'sideloading'</span> <span class="k">do</span>
  <span class="n">let!</span><span class="p">(</span><span class="ss">:employee</span><span class="p">)</span> <span class="p">{</span> <span class="n">create</span><span class="p">(</span><span class="ss">:employee</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s1">'current_position'</span> <span class="k">do</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:pos1</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">create</span><span class="p">(</span><span class="ss">:position</span><span class="p">,</span> <span class="ss">employee: </span><span class="n">employee</span><span class="p">,</span> <span class="ss">historical_index: </span><span class="mi">2</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:pos2</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">create</span><span class="p">(</span><span class="ss">:position</span><span class="p">,</span> <span class="ss">employee: </span><span class="n">employee</span><span class="p">,</span> <span class="ss">historical_index: </span><span class="mi">1</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">before</span> <span class="k">do</span>
      <span class="n">params</span><span class="p">[</span><span class="ss">:include</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'current_position'</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'returns position with historical index == 1'</span> <span class="k">do</span>
      <span class="n">render</span>
      <span class="n">sl</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">sideload</span><span class="p">(</span><span class="ss">:current_position</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">sl</span><span class="p">.</span><span class="nf">jsonapi_type</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">'positions'</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">sl</span><span class="p">.</span><span class="nf">id</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="n">pos2</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

  <p>Here we seed data, set the sideload parameter, and assert the correct
entity is present in the request. There is no need to test each
attribute of the sideload - this should be tested in the <a href="#resource-tests">Resource
Test</a> of the sideloaded Resource.</p>

  <p>In general, you only need to test sideloads when there is custom logic.
Our schema validation test will ensure no sideloads are removed or
associated to a different Resource.</p>

  <h3 id="writes">3.2 Writes</h3>

  <p>The basic setup for write operations:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># spec/resources/employee/writes_spec.rb</span>
<span class="nb">require</span> <span class="s1">'rails_helper'</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">EmployeeResource</span><span class="p">,</span> <span class="ss">type: :resource</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s1">'creating'</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:payload</span><span class="p">)</span> <span class="p">{</span> <span class="p">.</span><span class="nf">.</span><span class="o">.</span> <span class="p">}</span>
    <span class="c1"># ... code ...</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s1">'creating'</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:payload</span><span class="p">)</span> <span class="p">{</span> <span class="p">.</span><span class="nf">.</span><span class="o">.</span> <span class="p">}</span>
    <span class="c1"># ... code ...</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s1">'destroying'</span> <span class="k">do</span>
    <span class="c1"># ... code ...</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

  <p>Here <code class="highlighter-rouge">payload</code> is a <a href="http://jsonapi.org/format/#crud">JSONAPI Resource Object</a>.</p>

  <h4 id="create">3.2.1 Create</h4>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">describe</span> <span class="s1">'creating'</span> <span class="k">do</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:payload</span><span class="p">)</span> <span class="k">do</span>
    <span class="p">{</span>
      <span class="ss">data: </span><span class="p">{</span>
        <span class="ss">type: </span><span class="s1">'employees'</span><span class="p">,</span>
        <span class="ss">attributes: </span><span class="p">{</span> <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="k">end</span><span class="p">)</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:instance</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">EmployeeResource</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s1">'works'</span> <span class="k">do</span>
    <span class="n">expect</span> <span class="p">{</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">instance</span><span class="p">.</span><span class="nf">save</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
    <span class="p">}.</span><span class="nf">to</span> <span class="n">change</span> <span class="p">{</span> <span class="no">Employee</span><span class="p">.</span><span class="nf">count</span> <span class="p">}.</span><span class="nf">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

  <p>Here <code class="highlighter-rouge">payload</code> is an empty Employee <a href="http://jsonapi.org/format/#crud">Resource Object</a>.
We’ll assert that when saving this empty payload, an Employee is
created.</p>

  <p>You’ll likely want to add attributes here and ensure they are persisted
correctly:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">let</span><span class="p">(</span><span class="ss">:payload</span><span class="p">)</span> <span class="k">do</span>
  <span class="p">{</span>
    <span class="ss">data: </span><span class="p">{</span>
      <span class="ss">type: </span><span class="s1">'employees'</span><span class="p">,</span>
      <span class="ss">attributes: </span><span class="p">{</span> <span class="ss">first_name: </span><span class="s1">'Jane'</span><span class="p">,</span> <span class="ss">age: </span><span class="mi">30</span> <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="k">end</span>

<span class="c1"># ... code ...</span>

<span class="n">it</span> <span class="s1">'works'</span> <span class="k">do</span>
  <span class="n">expect</span> <span class="p">{</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">instance</span><span class="p">.</span><span class="nf">save</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
  <span class="p">}.</span><span class="nf">to</span> <span class="n">change</span> <span class="p">{</span> <span class="no">Employee</span><span class="p">.</span><span class="nf">count</span> <span class="p">}.</span><span class="nf">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">employee</span> <span class="o">=</span> <span class="no">Employee</span><span class="p">.</span><span class="nf">last</span>
  <span class="n">expect</span><span class="p">(</span><span class="n">employee</span><span class="p">.</span><span class="nf">first_name</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">'Jane'</span><span class="p">)</span>
  <span class="n">expect</span><span class="p">(</span><span class="n">employee</span><span class="p">.</span><span class="nf">age</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
<span class="k">end</span></code></pre></figure>

  <h5 id="required-belongs-to">3.2.1.1 Required Belongs To</h5>

  <p><a href="https://blog.bigbinary.com/2016/02/15/rails-5-makes-belong-to-association-required-by-default.html">Rails 5 made belongs_to required by default</a>. This means that if Employee <code class="highlighter-rouge">belongs_to :department</code>, the above tests will fail (we cannot create the Employee without associating it to Department).</p>

  <p>You have 3 options here:</p>

  <ul>
    <li>Turn off this validation in test mode. Add <code class="highlighter-rouge">config.active_record.belongs_to_required_by_default = false</code> to <code class="highlighter-rouge">config/environments/test.rb</code>.</li>
    <li>Turn off the validation for this specific relationship: <code class="highlighter-rouge">belongs_to :department, optional: true</code>.</li>
    <li>Associate as part of the request.</li>
  </ul>

  <p>We recommend the third option to preserve real-world end-to-end
behavior:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">describe</span> <span class="s1">'creating'</span> <span class="k">do</span>
  <span class="n">let!</span><span class="p">(</span><span class="ss">:department</span><span class="p">)</span> <span class="p">{</span> <span class="n">create</span><span class="p">(</span><span class="ss">:department</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:payload</span><span class="p">)</span> <span class="k">do</span>
    <span class="p">{</span>
      <span class="ss">type: </span><span class="s1">'employees'</span><span class="p">,</span>
      <span class="ss">attributes: </span><span class="p">{</span> <span class="p">.</span><span class="nf">.</span><span class="o">.</span> <span class="p">},</span>
      <span class="ss">relationships: </span><span class="p">{</span>
        <span class="ss">department: </span><span class="p">{</span>
          <span class="ss">data: </span><span class="p">{</span>
            <span class="ss">type: </span><span class="s1">'departments'</span><span class="p">,</span>
            <span class="ss">id: </span><span class="n">department</span><span class="p">.</span><span class="nf">id</span><span class="p">.</span><span class="nf">to_s</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="k">end</span>

  <span class="c1"># ... code ...</span>
<span class="k">end</span></code></pre></figure>

  <p>Will ensure the Employee is created and associated to the given
department.</p>

  <h4 id="update">3.2.2 Update</h4>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">describe</span> <span class="s1">'updating'</span> <span class="k">do</span>
  <span class="n">let!</span><span class="p">(</span><span class="ss">:employee</span><span class="p">)</span> <span class="p">{</span> <span class="n">create</span><span class="p">(</span><span class="ss">:employee</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:payload</span><span class="p">)</span> <span class="k">do</span>
    <span class="p">{</span>
      <span class="ss">data: </span><span class="p">{</span>
        <span class="ss">id: </span><span class="n">employee</span><span class="p">.</span><span class="nf">id</span><span class="p">.</span><span class="nf">to_s</span><span class="p">,</span>
        <span class="ss">type: </span><span class="s1">'employees'</span><span class="p">,</span>
        <span class="ss">attributes: </span><span class="p">{</span> <span class="ss">first_name: </span><span class="s1">'changed!'</span> <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:instance</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">EmployeeResource</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s1">'works'</span> <span class="k">do</span>
    <span class="n">expect</span> <span class="p">{</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">instance</span><span class="p">.</span><span class="nf">update_attributes</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
    <span class="p">}.</span><span class="nf">to</span> <span class="n">change</span> <span class="p">{</span> <span class="n">employee</span><span class="p">.</span><span class="nf">reload</span><span class="p">.</span><span class="nf">updated_at</span> <span class="p">}</span>
     <span class="p">.</span><span class="nf">and</span> <span class="n">change</span> <span class="p">{</span> <span class="n">employee</span><span class="p">.</span><span class="nf">first_name</span> <span class="p">}.</span><span class="nf">to</span><span class="p">(</span><span class="s1">'changed!'</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

  <blockquote>
    <p>Note that this test will be pending by default when using the
generator, as we require the attributes to be explicitly defined.</p>
  </blockquote>

  <p>Here <code class="highlighter-rouge">payload</code> is an empty Employee <a href="http://jsonapi.org/format/#crud">Resource Object</a>.
We’ll assert that when updating attributes, the changes are correctly
persisted to the database.</p>

  <h4 id="destroy">3.2.3 Destroy</h4>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">describe</span> <span class="s1">'destroying'</span> <span class="k">do</span>
  <span class="n">let!</span><span class="p">(</span><span class="ss">:employee</span><span class="p">)</span> <span class="p">{</span> <span class="n">create</span><span class="p">(</span><span class="ss">:employee</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:instance</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">EmployeeResource</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="ss">id: </span><span class="n">employee</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s1">'works'</span> <span class="k">do</span>
    <span class="n">expect</span> <span class="p">{</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">instance</span><span class="p">.</span><span class="nf">destroy</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
    <span class="p">}.</span><span class="nf">to</span> <span class="n">change</span> <span class="p">{</span> <span class="no">Employee</span><span class="p">.</span><span class="nf">count</span> <span class="p">}.</span><span class="nf">by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

  <p>Here we ensure that a delete request correctly removes a record from the
database.</p>

  <h4 id="side-effects">3.2.4 Side Effects</h4>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">it</span> <span class="s1">'works'</span> <span class="k">do</span>
  <span class="c1"># some assertion</span>
  <span class="n">email</span> <span class="o">=</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">deliveries</span><span class="p">.</span><span class="nf">last</span>
  <span class="n">expect</span><span class="p">(</span><span class="n">email</span><span class="p">.</span><span class="nf">subject</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">'Welcome!'</span><span class="p">)</span>
<span class="k">end</span></code></pre></figure>

  <p>It’s common for write operations to cause side-effects, such as sending
an email or updating an audit trail. It’s recommended to test these
<em>within the same “it” block</em> unless the logic gets particularly intense.
Though “one expectation per test” works well for unit tests, integration
tests can take longer to run and the performance penalty isn’t worth it.</p>

  <h2 id="api-tests">4 API Tests</h2>

  <p>There are five test files for each Resource:</p>

  <ul>
    <li><code class="highlighter-rouge">spec/api/v1/employees/index_spec.rb</code></li>
    <li><code class="highlighter-rouge">spec/api/v1/employees/show_spec.rb</code></li>
    <li><code class="highlighter-rouge">spec/api/v1/employees/create_spec.rb</code></li>
    <li><code class="highlighter-rouge">spec/api/v1/employees/update_spec.rb</code></li>
    <li><code class="highlighter-rouge">spec/api/v1/employees/destroy_spec.rb</code></li>
  </ul>

  <h3 id="reads-1">4.1 Reads</h3>

  <h4 id="index">4.1.1 <code class="highlighter-rouge">index</code></h4>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">'rails_helper'</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="s2">"employees#index"</span><span class="p">,</span> <span class="ss">type: :request</span> <span class="k">do</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:params</span><span class="p">)</span> <span class="p">{</span> <span class="p">{}</span> <span class="p">}</span>

  <span class="n">subject</span><span class="p">(</span><span class="ss">:make_request</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">jsonapi_get</span> <span class="s2">"/api/v1/employees"</span><span class="p">,</span> <span class="ss">params: </span><span class="n">params</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s1">'basic fetch'</span> <span class="k">do</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:employee1</span><span class="p">)</span> <span class="p">{</span> <span class="n">create</span><span class="p">(</span><span class="ss">:employee</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:employee2</span><span class="p">)</span> <span class="p">{</span> <span class="n">create</span><span class="p">(</span><span class="ss">:employee</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">it</span> <span class="s1">'works'</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="no">EmployeeResource</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:all</span><span class="p">).</span><span class="nf">and_call_original</span>
      <span class="n">make_request</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">status</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:jsonapi_type</span><span class="p">).</span><span class="nf">uniq</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">to</span> <span class="n">match_array</span><span class="p">([</span><span class="s1">'employees'</span><span class="p">])</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:id</span><span class="p">))</span>
        <span class="p">.</span><span class="nf">to</span> <span class="n">match_array</span><span class="p">([</span><span class="n">employee1</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="n">employee2</span><span class="p">.</span><span class="nf">id</span><span class="p">])</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

  <p>Here we’re ensuring <code class="highlighter-rouge">EmployeeResource</code> is the correct resource to be
called from this endpoint, we get a 200 status code, and the entities
returned are expected.</p>

  <h4 id="show">4.1.2 <code class="highlighter-rouge">show</code></h4>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">'rails_helper'</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="s2">"employees#show"</span><span class="p">,</span> <span class="ss">type: :request</span> <span class="k">do</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:params</span><span class="p">)</span> <span class="p">{</span> <span class="p">{}</span> <span class="p">}</span>

  <span class="n">subject</span><span class="p">(</span><span class="ss">:make_request</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">jsonapi_get</span> <span class="s2">"/api/v1/employees/</span><span class="si">#{</span><span class="n">employee</span><span class="p">.</span><span class="nf">id</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="ss">params: </span><span class="n">params</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s1">'basic fetch'</span> <span class="k">do</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:employee</span><span class="p">)</span> <span class="p">{</span> <span class="n">create</span><span class="p">(</span><span class="ss">:employee</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">it</span> <span class="s1">'works'</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="no">EmployeeResource</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:find</span><span class="p">).</span><span class="nf">and_call_original</span>
      <span class="n">make_request</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">status</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="nf">jsonapi_type</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">'employees'</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="nf">id</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="n">employee</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

  <p>Similar to <code class="highlighter-rouge">index</code>, but fetching only a single Employee.</p>

  <h3 id="writes-1">4.2 Writes</h3>

  <h4 id="create-1">4.2.1 <code class="highlighter-rouge">create</code></h4>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">'rails_helper'</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="s2">"employees#create"</span><span class="p">,</span> <span class="ss">type: :request</span> <span class="k">do</span>
  <span class="n">subject</span><span class="p">(</span><span class="ss">:make_request</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">jsonapi_post</span> <span class="s2">"/api/v1/employees"</span><span class="p">,</span> <span class="n">payload</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s1">'basic create'</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:payload</span><span class="p">)</span> <span class="k">do</span>
      <span class="p">{</span>
        <span class="ss">data: </span><span class="p">{</span>
          <span class="ss">type: </span><span class="s1">'employees'</span><span class="p">,</span>
          <span class="ss">attributes: </span><span class="p">{</span>
            <span class="ss">first_name: </span><span class="s1">'Jane'</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'works'</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="no">EmployeeResource</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:build</span><span class="p">).</span><span class="nf">and_call_original</span>
      <span class="n">expect</span> <span class="p">{</span>
        <span class="n">make_request</span>
      <span class="p">}.</span><span class="nf">to</span> <span class="n">change</span> <span class="p">{</span> <span class="no">Employee</span><span class="p">.</span><span class="nf">count</span> <span class="p">}.</span><span class="nf">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">status</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">201</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

  <p>Here we’re ensuring EmployeeResource is called, a record is correctly
inserted, and the response code is <code class="highlighter-rouge">201</code>.</p>

  <p>You probably only want to add attributes required to pass validation,
here - note that we don’t assert on attributes of the created record
(save this for your Resource test). One easy way to do this is to pass
randomized data from your factory:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">let</span><span class="p">(</span><span class="ss">:payload</span><span class="p">)</span> <span class="k">do</span>
  <span class="p">{</span>
    <span class="ss">data: </span><span class="p">{</span>
      <span class="ss">type: </span><span class="s1">'employees'</span><span class="p">,</span>
      <span class="ss">attributes: </span><span class="n">attributes_for</span><span class="p">(</span><span class="ss">:employee</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="k">end</span></code></pre></figure>

  <p>See also:</p>

  <ul>
    <li><a href="#required-belongs-to">Dealing with required belongs_to relationships</a>.</li>
  </ul>

  <h4 id="update-1">4.2.2 <code class="highlighter-rouge">update</code></h4>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">'rails_helper'</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="s2">"employees#update"</span><span class="p">,</span> <span class="ss">type: :request</span> <span class="k">do</span>
  <span class="n">subject</span><span class="p">(</span><span class="ss">:make_request</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">jsonapi_put</span> <span class="s2">"/api/v1/employees/</span><span class="si">#{</span><span class="n">employee</span><span class="p">.</span><span class="nf">id</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">payload</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s1">'basic update'</span> <span class="k">do</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:employee</span><span class="p">)</span> <span class="p">{</span> <span class="n">create</span><span class="p">(</span><span class="ss">:employee</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">let</span><span class="p">(</span><span class="ss">:payload</span><span class="p">)</span> <span class="k">do</span>
      <span class="p">{</span>
        <span class="ss">data: </span><span class="p">{</span>
          <span class="ss">id: </span><span class="n">employee</span><span class="p">.</span><span class="nf">id</span><span class="p">.</span><span class="nf">to_s</span><span class="p">,</span>
          <span class="ss">type: </span><span class="s1">'employees'</span><span class="p">,</span>
          <span class="ss">attributes: </span><span class="p">{</span>
            <span class="ss">first_name: </span><span class="s1">'changed!'</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'updates the resource'</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="no">EmployeeResource</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:find</span><span class="p">).</span><span class="nf">and_call_original</span>
      <span class="n">expect</span> <span class="p">{</span>
        <span class="n">make_request</span>
      <span class="p">}.</span><span class="nf">to</span> <span class="n">change</span> <span class="p">{</span> <span class="n">employee</span><span class="p">.</span><span class="nf">reload</span><span class="p">.</span><span class="nf">attributes</span> <span class="p">}</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">status</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

  <p>Here we’re ensuring EmployeeResource is called, attributes are updated,
and we respond with a 201. Note that we don’t assert on specific
attributes - save that for your Resource test.</p>

  <p>Just like the prior section, you may want to leverage FactoryBot here to
generate randomized attributes:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">let</span><span class="p">(</span><span class="ss">:payload</span><span class="p">)</span> <span class="k">do</span>
  <span class="p">{</span>
    <span class="ss">data: </span><span class="p">{</span>
      <span class="ss">id: </span><span class="n">employee</span><span class="p">.</span><span class="nf">id</span><span class="p">.</span><span class="nf">to_s</span><span class="p">,</span>
      <span class="ss">type: </span><span class="s1">'employees'</span><span class="p">,</span>
      <span class="ss">attributes: </span><span class="n">attributes_for</span><span class="p">(</span><span class="ss">:employee</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="k">end</span></code></pre></figure>

  <h4 id="destroy-1">4.2.3 <code class="highlighter-rouge">destroy</code></h4>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">'rails_helper'</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="s2">"employees#destroy"</span><span class="p">,</span> <span class="ss">type: :request</span> <span class="k">do</span>
  <span class="n">subject</span><span class="p">(</span><span class="ss">:make_request</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">jsonapi_delete</span> <span class="s2">"/api/v1/employees/</span><span class="si">#{</span><span class="n">employee</span><span class="p">.</span><span class="nf">id</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s1">'basic destroy'</span> <span class="k">do</span>
    <span class="n">let!</span><span class="p">(</span><span class="ss">:employee</span><span class="p">)</span> <span class="p">{</span> <span class="n">create</span><span class="p">(</span><span class="ss">:employee</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">it</span> <span class="s1">'updates the resource'</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="no">EmployeeResource</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:find</span><span class="p">).</span><span class="nf">and_call_original</span>
      <span class="n">expect</span> <span class="p">{</span> <span class="n">make_request</span> <span class="p">}.</span><span class="nf">to</span> <span class="n">change</span> <span class="p">{</span> <span class="no">Employee</span><span class="p">.</span><span class="nf">count</span> <span class="p">}.</span><span class="nf">by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">expect</span> <span class="p">{</span> <span class="n">employee</span><span class="p">.</span><span class="nf">reload</span> <span class="p">}</span>
        <span class="p">.</span><span class="nf">to</span> <span class="n">raise_error</span><span class="p">(</span><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">RecordNotFound</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">status</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">json</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">'meta'</span> <span class="o">=&gt;</span> <span class="p">{})</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

  <p>Here we’re sending a DELETE request, ensuring the record is actually
removed, and we respond <a href="http://jsonapi.org/format/#crud-deleting-responses-200">according to the JSONAPI specification</a>.</p>

  <h1 id="context">5 Context</h1>

  <p>Occasionally you’ll need to set context for tests. The most common
scenario is authorization:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">attribute</span> <span class="ss">:salary</span><span class="p">,</span> <span class="ss">:integer</span><span class="p">,</span> <span class="ss">readable: :admin?</span>

<span class="k">def</span> <span class="nf">admin?</span>
  <span class="n">context</span><span class="p">.</span><span class="nf">current_user</span><span class="p">.</span><span class="nf">admin?</span>
<span class="k">end</span></code></pre></figure>

  <p>When using Rails, <code class="highlighter-rouge">context</code> is the controller associated to the request.
We can manually set context in tests:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="n">double</span><span class="p">(</span><span class="n">admin?</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span> <span class="p">}</span>
<span class="n">let</span><span class="p">(</span><span class="ss">:ctx</span><span class="p">)</span> <span class="p">{</span> <span class="n">double</span><span class="p">(</span><span class="ss">current_user: </span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>

<span class="n">it</span> <span class="s1">'works'</span> <span class="k">do</span>
  <span class="no">Graphiti</span><span class="p">.</span><span class="nf">with_context</span> <span class="n">ctx</span> <span class="k">do</span>
    <span class="n">render</span>
  <span class="k">end</span>
  <span class="n">expect</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">salary</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">100_000</span><span class="p">)</span>
<span class="k">end</span></code></pre></figure>

  <p><br /></p>

  <h1 id="schema-validation">6 Schema Validation</h1>

  <p>Graphiti comes with built-in backwards-compatibility tests. We do this
by comparing the current version of the schema with one previously
checked-in.</p>

  <p>These tests are added at the bottom of <code class="highlighter-rouge">spec/rails_helper.rb</code>:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">GraphitiSpecHelpers</span><span class="o">::</span><span class="no">RSpec</span><span class="p">.</span><span class="nf">schema!</span></code></pre></figure>

  <p>Whenever you run tests, the schema check will <em>also</em> run. If we find any
backwards-incompatibilities - attributes removed, types changed, default
sort direction modified, etc - the schema test will fail with an output
detailing all incompatibilities.</p>

  <p>When the schema test succeeds, it will overwrite the existing schema
file with the new schema. It will not do this on failure.</p>

  <p>There are times when you want to accept an incompatibility and move on
anyway. In this case, use <code class="highlighter-rouge">FORCE_SCHEMA</code>:</p>

  <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$ </span><span class="nv">FORCE_SCHEMA</span><span class="o">=</span><span class="nb">true </span>bin/rspec</code></pre></figure>

  <p><br /></p>

  <h1 id="testing-spectrum">7 Testing Spectrum</h1>

  <p>Testing standards vary from team to team, and there is no right answer
when judging “the right level of testing”.</p>

  <p>You <em>could</em> add tests for every attribute, validating every sort and
filter. Or, you could consider logicless configuration tested as part of
Graphiti itself (the same way we don’t tend to test a <code class="highlighter-rouge">has_many</code>
ActiveRecord relationship). Though our guides favor the latter, the
extra tests could prove useful when performing a major upgrade or
swapping datastores.</p>

  <p>You <em>could</em> do more API testing, particularly for high-value
functionality. Testing fully end-to-end, from middleware to response
codes, gives a high level of confidence. But it can also feel like
duplicate tests across endpoints, which is why we have Resource tests.</p>

  <p>Graphiti provides sensible defaults, but you’re encouraged to consider
the tradeoffs and pick the right level of testing for <em>you</em>.</p>

  <h1 id="double-testing-units">7 Double-Testing Units</h1>

  <p>Integration testing is great: it gives a high level of confidence, and
they’re typically the easiest tests to write. In fact, these tests are
so powerful the value of unit testing sometimes comes up for debate.</p>

  <p>Consider a custom filter powered by an ActiveRecord scope:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># app/resources/employee_resource.rb</span>
<span class="n">filter</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">:string</span> <span class="k">do</span>
  <span class="n">eq</span> <span class="k">do</span> <span class="o">|</span><span class="n">scope</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
    <span class="n">scope</span><span class="p">.</span><span class="nf">by_title</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># app/models/employee.rb</span>
<span class="n">scope</span> <span class="ss">:by_title</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">title</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">joins</span><span class="p">(</span><span class="ss">:current_position</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"lower(title) = ?"</span><span class="p">,</span> <span class="n">title</span><span class="p">.</span><span class="nf">downcase</span><span class="p">)</span>
<span class="p">}</span></code></pre></figure>

  <p>If we’re by-the-book, we should absolutely test <code class="highlighter-rouge">.by_title</code> on the
Employee model. After all, we’re exposing a public interface that other
developers might rely on in the future.</p>

  <p>This can feel cumbersome, even duplicative. The Resource Test of the
title filter will seed the same data as the corresponding unit test, and
the assertion will be almost identical. But because Resource Tests are
<em>integration</em> tests, we shouldn’t mock the code either.</p>

  <p>The best practice here is to use <a href="https://relishapp.com/rspec/rspec-core/docs/example-groups/shared-context">RSpec shared_context</a> to remove the duplication:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># spec/support/employees_helper.rb</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">shared_context</span> <span class="s1">'employees by title'</span> <span class="k">do</span>
  <span class="n">let!</span><span class="p">(</span><span class="ss">:employee1</span><span class="p">)</span> <span class="p">{</span> <span class="n">create</span><span class="p">(</span><span class="ss">:employee</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">let!</span><span class="p">(</span><span class="ss">:employee2</span><span class="p">)</span> <span class="p">{</span> <span class="n">create</span><span class="p">(</span><span class="ss">:employee</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">let!</span><span class="p">(</span><span class="ss">:employee3</span><span class="p">)</span> <span class="p">{</span> <span class="n">create</span><span class="p">(</span><span class="ss">:employee</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">let!</span><span class="p">(</span><span class="ss">:position1</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">create</span><span class="p">(</span><span class="ss">:position</span><span class="p">,</span> <span class="ss">title: </span><span class="s1">'foo'</span><span class="p">,</span> <span class="ss">employee: </span><span class="n">employee1</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="n">let!</span><span class="p">(</span><span class="ss">:position2</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">create</span><span class="p">(</span><span class="ss">:position</span><span class="p">,</span> <span class="ss">title: </span><span class="s1">'BAR'</span><span class="p">,</span> <span class="ss">employee: </span><span class="n">employee2</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="n">let!</span><span class="p">(</span><span class="ss">:position3</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">create</span><span class="p">(</span><span class="ss">:position</span><span class="p">,</span> <span class="ss">title: </span><span class="s1">'bar'</span><span class="p">,</span> <span class="ss">employee: </span><span class="n">employee3</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># spec/models/employee.rb</span>
<span class="n">describe</span> <span class="s1">'.by_title'</span> <span class="k">do</span>
  <span class="n">include_context</span> <span class="s1">'employees by title'</span>

  <span class="n">it</span> <span class="s1">'returns employees matching the given title'</span> <span class="k">do</span>
    <span class="n">expect</span><span class="p">(</span><span class="no">Employee</span><span class="p">.</span><span class="nf">by_title</span><span class="p">(</span><span class="s1">'bar'</span><span class="p">))</span>
      <span class="p">.</span><span class="nf">to</span> <span class="n">eq</span><span class="p">([</span><span class="n">employee2</span><span class="p">,</span> <span class="n">employee3</span><span class="p">])</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># spec/resources/employee_resource.rb</span>
<span class="n">describe</span> <span class="s1">'filtering'</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s1">'by title'</span> <span class="k">do</span>
    <span class="n">include_context</span> <span class="s1">'employees by title'</span>

    <span class="n">before</span> <span class="k">do</span>
      <span class="n">params</span><span class="p">[</span><span class="ss">:filter</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">title: </span><span class="s1">'bar'</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'returns employees matching the given title'</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">records</span><span class="p">).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">([</span><span class="n">employee2</span><span class="p">,</span> <span class="n">employee3</span><span class="p">])</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

  <p>This <strong>allows our <code class="highlighter-rouge">by_title</code> scope to be re-used by future developers
outside of the Resource context</strong>. It also keeps code clean and
isolated.</p>

  <p>But it’s not unreasonable to think the overhead here isn’t worth it. If
you’re of this mind, we recommend testing the Resource and marking the
method as not re-usable:</p>

  <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># @api private</span>
<span class="n">scope</span> <span class="ss">:by_title</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span> <span class="p">.</span><span class="nf">.</span><span class="o">.</span> <span class="p">}</span></code></pre></figure>

  <p>This way future developers know the scope is only an implementation
detail and not considered part of this object’s public API. Writing the
unit test can be deferred until the use case actually arises.</p>

  <h2 id="generators">9 Generators</h2>

  <p>The <a href="https://graphiti-api.github.io/graphiti/guides/concepts/resources#generators">Resource generator</a> will create both Resource and API tests for you.
Use these as templates to implement your tests.</p>

  <p>You can also run</p>

  <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$ </span>rails generate graphiti:api_test RESOURCE <span class="o">[</span>options]</code></pre></figure>

  <p>For example</p>

  <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$ </span>rails generate graphiti:api_test EmployeeResource -a index show</code></pre></figure>

  <p>To generate only the API tests. This can be particularly helpful because
API tests are mostly boilerplate that does not need to be manually
edited. Pass the <code class="highlighter-rouge">-a</code> option to limit RESTful actions.</p>
</div>

        </div>
      </div>
    </main>
    <div class="main-footer main-footer--dark">
  <div class="container">
    <div class="row">
      <div class="col-sm-4 menu">
        <h3>Overview</h3>
        <ul>
          <li>
            <a href="https://graphiti-api.github.io/graphiti/quickstart">Quickstart</a>
          </li>
          <li>
            <a href="https://graphiti-api.github.io/graphiti/tutorial">Tutorial</a>
          </li>
          <li>
            <a href="https://graphiti-api.github.io/graphiti/guides">Guides</a>
          </li>
        </ul>
      </div>
      <div class="col-sm-4 menu">
        <h3>Contact</h3>
        <ul>
          <li>
            <a target="_blank" href="https://join.slack.com/t/jsonapi-suite/shared_invite/enQtMjkyMTA3MDgxNTQzLWVkMDM3NTlmNTIwODY2YWFkMGNiNzUzZGMzOTY3YmNmZjBhYzIyZWZlZTk4YmI1YTI0Y2M0OTZmZGYwN2QxZjg">Slack Chat</a>
          </li>
          <li>
            <a href="mailto:richmolj@gmail.com">Email</a>
          </li>
        </ul>
      </div>
      <div class="col-sm-4 menu">
        <h3>Related</h3>
        <ul>
          <li>
            <a target="_blank" href="http://jsonapi.org">JSONAPI Spec</a>
          </li>
          <li>
            <a target="_blank" href="http://jsonapi-rb.org">jsonapi-rb</a>
          </li>
          <li>
            <a target="_blank" href="https://vuejs.org/">VueJS</a>
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>

    <script type="text/javascript">
$(function () {

  var flipTabs = function() {
    var isTS = true;
    if (localStorage.getItem('js-lang') === 'javascript') {
      isTS = false;
    }

    $('.code-tabs').each(function(index, el) {
      if (isTS) {
        console.log('hiding js');
        $($(el).children()[1]).hide();
        $($(el).children()[0]).show();
      } else {
        console.log('hiding ts');
        $($(el).children()[0]).hide();
        $($(el).children()[1]).show();
      }
    });

    if (isTS) {
      $('.tab.typescript').addClass('active');
      $('.tab.javascript').removeClass('active');
    } else {
      $('.tab.typescript').removeClass('active');
      $('.tab.javascript').addClass('active');
    }
  }

  $('.tab').click(function() {
    if ($(this).hasClass('typescript')) {
      localStorage.setItem('js-lang', 'typescript');
    } else {
      localStorage.setItem('js-lang', 'javascript');
    }

    flipTabs();
  });

  flipTabs();
})
</script>

  </body>
</html>
